<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG-bank - –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="bank-container">
        <div class="bank-header">
            <div class="logo-area">
                <div class="bank-logo">TG-bank</div>
                <div class="badge">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</div>
            </div>
            <div class="user-profile">
                <span class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <div class="dashboard-content">
            <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
            <div class="greeting-block">
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="userFullName">...</span>!</h2>
                <p>–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º–∏ –∫—Ä–µ–¥–∏—Ç–∞–º–∏</p>
            </div>

            <!-- –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞ -->
            <div class="loan-application" id="loanApplication">
                <h3>–û—Ñ–æ—Ä–º–∏—Ç—å –Ω–æ–≤—ã–π –∫—Ä–µ–¥–∏—Ç</h3>
                <div class="loan-form">
                    <div class="form-group">
                        <label>–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ (–æ—Ç 10 000 –¥–æ 5 000 000 ‚ÇΩ)</label>
                        <input type="number" id="loanAmount" min="10000" max="5000000" step="10000" value="500000">
                    </div>
                    <div class="form-group">
                        <label>–°—Ä–æ–∫ (–º–µ—Å—è—Ü–µ–≤, –æ—Ç 6 –¥–æ 60)</label>
                        <input type="number" id="loanTerm" min="6" max="60" step="6" value="24">
                    </div>
                    <button class="apply-button" onclick="applyForLoan()">–û—Ñ–æ—Ä–º–∏—Ç—å –∫—Ä–µ–¥–∏—Ç</button>
                </div>
                <div id="loanError" class="error-message"></div>
                <div id="loanSuccess" class="success-message"></div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –∫—Ä–µ–¥–∏—Ç–æ–≤ -->
            <div class="loans-list" id="loansList">
                <h3>–í–∞—à–∏ –∫—Ä–µ–¥–∏—Ç—ã</h3>
                <div id="noLoans" class="no-loans">
                    –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞ -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>–í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂</h3>
            <div id="paymentInfo" class="payment-info"></div>
            <div class="form-group">
                <label>–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ (‚ÇΩ)</label>
                <input type="number" id="paymentAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" min="1">
            </div>
            <button class="payment-button" onclick="makePayment()">–í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂</button>
            <div id="paymentResult" class="payment-result"></div>
        </div>
    </div>

    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞ */
        .success-message {
            color: #28a745;
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .payment-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .payment-info p {
            margin: 8px 0;
            font-size: 14px;
        }
        
        .payment-info .penalty {
            color: #dc3545;
            font-weight: 600;
        }
        
        .payment-result .success {
            color: #28a745;
            font-weight: 500;
            padding: 10px;
            background: #d4edda;
            border-radius: 5px;
        }
        
        .payment-result .error {
            color: #dc3545;
            font-weight: 500;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
        }
        
        .loan-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .loan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .loan-header.overdue {
            border-bottom-color: #dc3545;
        }
        
        .loan-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #e9ecef;
        }
        
        .loan-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .detail-item span {
            color: #666;
        }
        
        .detail-item strong {
            color: #333;
        }
        
        .penalty {
            color: #dc3545;
            font-weight: 600;
        }
        
        .payment-btn, .schedule-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            margin-right: 10px;
            transition: 0.2s;
        }
        
        .payment-btn {
            background: #28a745;
            color: white;
        }
        
        .payment-btn:hover {
            background: #218838;
        }
        
        .schedule-btn {
            background: #007bff;
            color: white;
        }
        
        .schedule-btn:hover {
            background: #0056b3;
        }
        
        .payment-schedule {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .schedule-table th {
            background: #343a40;
            color: white;
            padding: 10px;
            text-align: center;
        }
        
        .schedule-table td {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            text-align: center;
        }
        
        .schedule-table tr.paid {
            background: #d4edda;
        }
        
        .schedule-table tr.overdue {
            background: #f8d7da;
        }
        
        .schedule-table tr.pending {
            background: #fff3cd;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }
        
        .close:hover {
            color: #333;
        }
        
        .no-loans {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 10px;
            color: #666;
            font-size: 16px;
        }
        
        .apply-button {
            padding: 12px 30px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: 0.2s;
        }
        
        .apply-button:hover {
            background: #218838;
        }
        
        .error-message {
            color: #dc3545;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ–Ω–µ–π */
        .feedback-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .feedback-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .feedback-message.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-paid {
            background-color: #d4edda;
            color: #155724;
        }

        .status-overdue {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .overdue-row {
            background-color: rgba(220, 53, 69, 0.05);
        }

        .empty-table {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }  
    </style>

    <script>
        // Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        let currentLoanId = null;
        let userData = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function checkAuth() {
            try {
                console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
                const response = await fetch('/api/check-auth', {
                    credentials: 'include'  // –í–ê–ñ–ù–û!
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', data);
                
                if (!data.authenticated) {
                    console.log('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ª–æ–≥–∏–Ω');
                    window.location.href = '/login';
                    return;
                }

                document.getElementById('userName').textContent = data.user.username;
                document.getElementById('userFullName').textContent = data.user.full_name;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await loadUserData();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                document.getElementById('userName').textContent = '–û—à–∏–±–∫–∞';
                document.getElementById('userFullName').textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                
                const noLoans = document.getElementById('noLoans');
                noLoans.innerHTML = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.';
                noLoans.style.display = 'block';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                const response = await fetch('/api/user-data');
                
                if (!response.ok) {
                    throw new Error(`HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status}`);
                }
                
                userData = await response.json();
                console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', userData);
                
                displayLoans(userData.loans);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                
                const noLoans = document.getElementById('noLoans');
                noLoans.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                noLoans.style.display = 'block';
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤
        function displayLoans(loans) {
            const loansList = document.getElementById('loansList');
            const noLoans = document.getElementById('noLoans');
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤
            const oldCards = loansList.querySelectorAll('.loan-card:not(.no-loans)');
            oldCards.forEach(card => card.remove());

            if (!loans || loans.length === 0) {
                noLoans.style.display = 'block';
                return;
            }

            noLoans.style.display = 'none';

            loans.forEach(loan => {
                try {
                    const loanCard = createLoanCard(loan);
                    loansList.appendChild(loanCard);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∫—Ä–µ–¥–∏—Ç–∞:', error, loan);
                }
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫—Ä–µ–¥–∏—Ç–∞
        function createLoanCard(loan) {
            const card = document.createElement('div');
            card.className = 'loan-card';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂
            const nextPayment = loan.schedule ? loan.schedule.find(p => p.status === 'pending') : null;
            
            let penaltyInfo = '';
            let statusClass = '';
            let daysOverdue = 0;
            
            if (nextPayment) {
                const dueDate = new Date(nextPayment.due_date);
                dueDate.setHours(0, 0, 0, 0);
                
                if (today > dueDate) {
                    daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                    const penalty = nextPayment.amount * 0.001 * daysOverdue;
                    penaltyInfo = `<div class="detail-item"><span>–ü–µ–Ω—è (${daysOverdue} –¥–Ω.):</span> <strong class="penalty">${formatNumber(penalty)} ‚ÇΩ</strong></div>`;
                    statusClass = 'overdue';
                }
            }

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
            const nextPaymentDate = nextPayment ? formatDate(nextPayment.due_date) : '–ù–µ—Ç';

            card.innerHTML = `
                <div class="loan-header ${statusClass}">
                    <h4>–ö—Ä–µ–¥–∏—Ç ‚Ññ${loan.id}</h4>
                    <span class="loan-status">${getStatusText(loan.status)}</span>
                </div>
                <div class="loan-details">
                    <div class="detail-item">
                        <span>–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞:</span>
                        <strong>${formatNumber(loan.amount)} ‚ÇΩ</strong>
                    </div>
                    <div class="detail-item">
                        <span>–û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞:</span>
                        <strong>${formatNumber(loan.remaining_amount)} ‚ÇΩ</strong>
                    </div>
                    <div class="detail-item">
                        <span>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂:</span>
                        <strong>${formatNumber(loan.monthly_payment)} ‚ÇΩ</strong>
                    </div>
                    <div class="detail-item">
                        <span>–°—Ä–æ–∫ –∫—Ä–µ–¥–∏—Ç–∞:</span>
                        <strong>${loan.term_months} –º–µ—Å</strong>
                    </div>
                    <div class="detail-item">
                        <span>–°—Ç–∞–≤–∫–∞:</span>
                        <strong>${loan.interest_rate || 12.5}%</strong>
                    </div>
                    <div class="detail-item">
                        <span>–°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂:</span>
                        <strong>${nextPaymentDate}</strong>
                    </div>
                    ${penaltyInfo}
                </div>
                <button class="payment-btn" onclick="openPaymentModal(${loan.id})">üí∞ –í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂</button>
                <button class="schedule-btn" onclick="toggleSchedule(${loan.id})">üìÖ –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π</button>
                <div id="schedule-${loan.id}" class="payment-schedule" style="display: none;">
                    ${generateScheduleHTML(loan.schedule)}
                </div>
            `;
            
            return card;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
        function generateScheduleHTML(schedule) {
            if (!schedule || schedule.length === 0) {
                return '<p class="no-data">–ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>';
            }

            let html = '<table class="schedule-table"><tr><th>‚Ññ</th><th>–î–∞—Ç–∞</th><th>–°—É–º–º–∞</th><th>–û—Å–Ω. –¥–æ–ª–≥</th><th>%</th><th>–û—Å—Ç–∞—Ç–æ–∫</th><th>–°—Ç–∞—Ç—É—Å</th></tr>';
            
            schedule.forEach(p => {
                let statusClass = 'pending';
                let statusText = '–û–∂–∏–¥–∞–µ—Ç';
                
                if (p.status === 'paid') {
                    statusClass = 'paid';
                    statusText = '–û–ø–ª–∞—á–µ–Ω';
                } else {
                    const today = new Date();
                    const dueDate = new Date(p.due_date);
                    if (today > dueDate) {
                        statusClass = 'overdue';
                        statusText = '–ü—Ä–æ—Å—Ä–æ—á–∫–∞';
                    }
                }
                
                html += `
                    <tr class="${statusClass}">
                        <td>${p.payment_number}</td>
                        <td>${formatDate(p.due_date)}</td>
                        <td>${formatNumber(p.amount)} ‚ÇΩ</td>
                        <td>${formatNumber(p.principal)} ‚ÇΩ</td>
                        <td>${formatNumber(p.interest)} ‚ÇΩ</td>
                        <td>${formatNumber(p.remaining_balance)} ‚ÇΩ</td>
                        <td>${statusText}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            return html;
        }

        // –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞
        async function applyForLoan() {
            const amount = document.getElementById('loanAmount').value;
            const term = document.getElementById('loanTerm').value;
            const errorEl = document.getElementById('loanError');
            const successEl = document.getElementById('loanSuccess');

            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            errorEl.textContent = '';
            successEl.textContent = '';

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (amount < 10000 || amount > 5000000) {
                errorEl.textContent = '–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 10 000 –¥–æ 5 000 000 ‚ÇΩ';
                return;
            }

            if (term < 6 || term > 60) {
                errorEl.textContent = '–°—Ä–æ–∫ –∫—Ä–µ–¥–∏—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 6 –¥–æ 60 –º–µ—Å—è—Ü–µ–≤';
                return;
            }

            console.log('–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞:', { amount, term });

            try {
                const response = await fetch('/api/loans/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        amount: parseFloat(amount), 
                        term: parseInt(term) 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status}`);
                }

                const data = await response.json();
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);

                if (data.success) {
                    successEl.textContent = '‚úÖ –ö—Ä–µ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!';
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫—Ä–µ–¥–∏—Ç–æ–≤
                    await loadUserData();
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('loanAmount').value = 500000;
                    document.getElementById('loanTerm').value = 24;
                    
                    // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        successEl.textContent = '';
                    }, 3000);
                } else {
                    errorEl.textContent = data.error || '–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–∞';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                errorEl.textContent = '–û—à–∏–±–∫–∞: ' + error.message;
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞
        function openPaymentModal(loanId) {
            currentLoanId = loanId;
            const modal = document.getElementById('paymentModal');
            const paymentAmount = document.getElementById('paymentAmount');
            const paymentInfo = document.getElementById('paymentInfo');
            const paymentResult = document.getElementById('paymentResult');
            
            paymentAmount.value = '';
            paymentResult.innerHTML = '';
            
            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ª–µ–¥—É—é—â–µ–º –ø–ª–∞—Ç–µ–∂–µ
            const loan = userData.loans.find(l => l.id === loanId);
            if (loan && loan.schedule) {
                const nextPayment = loan.schedule.find(p => p.status === 'pending');
                
                if (nextPayment) {
                    const today = new Date();
                    const dueDate = new Date(nextPayment.due_date);
                    let penalty = 0;
                    let penaltyText = '';
                    
                    if (today > dueDate) {
                        const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                        penalty = nextPayment.amount * 0.001 * daysOverdue;
                        penaltyText = `<p class="penalty">‚ö†Ô∏è –ü–µ–Ω—è –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É: ${formatNumber(penalty)} ‚ÇΩ (${daysOverdue} –¥–Ω.)</p>`;
                    }
                    
                    const totalDue = nextPayment.amount + penalty;
                    
                    paymentInfo.innerHTML = `
                        <h4>–ü–ª–∞—Ç–µ–∂ –ø–æ –∫—Ä–µ–¥–∏—Ç—É ‚Ññ${loanId}</h4>
                        <p><strong>–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞:</strong> ${formatNumber(nextPayment.amount)} ‚ÇΩ</p>
                        <p><strong>–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞:</strong> ${formatDate(nextPayment.due_date)}</p>
                        ${penaltyText}
                        <p><strong>–í—Å–µ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</strong> ${formatNumber(totalDue)} ‚ÇΩ</p>
                        <p style="font-size:12px; color:#666; margin-top:10px;">* –ú–æ–∂–Ω–æ –≤–Ω–µ—Å—Ç–∏ –ª—é–±—É—é —Å—É–º–º—É</p>
                    `;
                } else {
                    paymentInfo.innerHTML = '<p>–ü–æ —ç—Ç–æ–º—É –∫—Ä–µ–¥–∏—Ç—É –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</p>';
                }
            }
            
            modal.style.display = 'block';
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É–º–º—É –ø–ª–∞—Ç–µ–∂–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            setTimeout(() => {
                if (loan && loan.monthly_payment) {
                    paymentAmount.value = Math.round(loan.monthly_payment);
                }
            }, 100);
        }

        // –í–Ω–µ—Å–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
        async function makePayment() {
            const amount = document.getElementById('paymentAmount').value;
            const resultEl = document.getElementById('paymentResult');

            if (!amount || amount <= 0) {
                resultEl.innerHTML = '<p class="error">‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É</p>';
                return;
            }

            resultEl.innerHTML = '<p>‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...</p>';

            try {
                console.log('–í–Ω–µ—Å–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:', { loanId: currentLoanId, amount });
                
                const response = await fetch('/api/payments/make', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        loanId: currentLoanId,
                        amount: parseFloat(amount)
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status}`);
                }

                const data = await response.json();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–ª–∞—Ç–µ–∂–∞:', data);

                if (data.success) {
                    resultEl.innerHTML = `<p class="success">‚úÖ ${data.message}</p>`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                    await loadUserData();
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        closeModal();
                    }, 2000);
                } else {
                    resultEl.innerHTML = `<p class="error">‚ùå ${data.error}</p>`;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞:', error);
                resultEl.innerHTML = `<p class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</p>`;
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –≥—Ä–∞—Ñ–∏–∫
        function toggleSchedule(loanId) {
            const schedule = document.getElementById(`schedule-${loanId}`);
            if (schedule) {
                if (schedule.style.display === 'none') {
                    schedule.style.display = 'block';
                } else {
                    schedule.style.display = 'none';
                }
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeModal() {
            document.getElementById('paymentModal').style.display = 'none';
            currentLoanId = null;
            document.getElementById('paymentResult').innerHTML = '';
        }

        // –í—ã—Ö–æ–¥
        async function logout() {
            try {
                console.log('–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
                const response = await fetch('/api/logout', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                window.location.href = '/login';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
                window.location.href = '/login';
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function formatNumber(num) {
            if (num === undefined || num === null) return '0';
            return new Intl.NumberFormat('ru-RU').format(Math.round(num));
        }

        function formatDate(dateStr) {
            if (!dateStr) return '–ù/–î';
            try {
                return new Date(dateStr).toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return dateStr;
            }
        }

        function getStatusText(status) {
            const statuses = {
                'active': '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω',
                'paid': 'üí∞ –û–ø–ª–∞—á–µ–Ω',
                'overdue': '‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω',
                'pending': '‚è≥ –û–∂–∏–¥–∞–µ—Ç'
            };
            return statuses[status] || status;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
            checkAuth();
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('paymentModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>